import pygame
import random
import sys
import pickle

# Inizializzazione Pygame
pygame.init()

# Impostazioni dello schermo
larghezza_schermo = 400
altezza_schermo = 400
schermo = pygame.display.set_mode((larghezza_schermo, altezza_schermo))
pygame.display.set_caption("Snake di giammy")

# Caricamento delle immagini
sfondo_img = pygame.image.load('sfondo_riprova.jpg')
sfondo_img = pygame.transform.scale(sfondo_img, (200, 200))

# Caricamento immagini della mela di varie dimensioni
mela_imgs = {
    10: pygame.transform.scale(pygame.image.load('mela.png'), (10, 10)),
    15: pygame.transform.scale(pygame.image.load('mela.png'), (15, 15)),
    20: pygame.transform.scale(pygame.image.load('mela.png'), (20, 20))
}

# Colori
nero = (0, 0, 0)
verde = (0, 200, 0)
bianco = (255, 255, 255)

# Impostazioni del serpente
dimensione_blocco = 20

# Font
font = pygame.font.SysFont(None, 30)

# Variabili di gioco
direzione = 'DESTRA'
cambio_direzione = direzione
mele_mangiate = 0
lunghezza_serpente = 1
serpente = []
testa_serpente = [larghezza_schermo / 2, altezza_schermo / 2]
serpente.append(testa_serpente)
dimensione_mela = 20  # Imposta la dimensione predefinita della mela
posizione_mela = [random.randint(1, (larghezza_schermo - dimensione_blocco) // dimensione_blocco) * dimensione_blocco,
                  random.randint(1, (altezza_schermo - dimensione_blocco) // dimensione_blocco) * dimensione_blocco]

# Variabile di fine partita
fine_partita = False

# Variabile di difficoltà
difficolta = 'normale'

# Velocità iniziale del serpente
velocita_serpente = 10

def mostra_menu():
    global difficolta
    menu = True

    while menu:
        schermo.fill(nero)
        mostra_testo("Scegli la difficoltà:", bianco, -50)
        mostra_testo("1. Facile", bianco, -10)
        mostra_testo("2. Normale", bianco, 20)
        mostra_testo("3. Difficile", bianco, 50)
        pygame.display.update()

        for evento in pygame.event.get():
            if evento.type == pygame.QUIT:
                pygame.quit()
                sys.exit()
            if evento.type == pygame.KEYDOWN:
                if evento.key == pygame.K_1:
                    difficolta = 'facile'
                    menu = False
                if evento.key == pygame.K_2:
                    difficolta = 'normale'
                    menu = False
                if evento.key == pygame.K_3:
                    difficolta = 'difficile'
                    menu = False

def fine_gioco():
    global fine_partita
    fine_partita = True

    while True:
        schermo.fill(nero)
        schermo.blit(sfondo_img, (100, 100))
        mostra_testo("Premi 'R' per riprovare o 'ESC' per uscire.", bianco, 150)
        mostra_punteggio()
        pygame.display.update()

        for evento in pygame.event.get():
            if evento.type == pygame.QUIT:
                pygame.quit()
                sys.exit()
            if evento.type == pygame.KEYDOWN:
                if evento.key == pygame.K_r:
                    fine_partita = False
                    reset_game()
                    return
                if evento.key == pygame.K_ESCAPE:
                    pygame.quit()
                    sys.exit()

def schermata_vittoria():
    while True:
        schermo.fill(nero)
        mostra_testo("Hai vinto!", bianco, -30)
        mostra_testo("Premi 'R' per riprovare o 'ESC' per uscire.", bianco, 10)
        pygame.display.update()

        for evento in pygame.event.get():
            if evento.type == pygame.QUIT:
                pygame.quit()
                sys.exit()
            if evento.type == pygame.KEYDOWN:
                if evento.key == pygame.K_r:
                    reset_game()
                    return
                if evento.key == pygame.K_ESCAPE:
                    pygame.quit()
                    sys.exit()

def reset_game():
    global direzione, cambio_direzione, mele_mangiate, lunghezza_serpente, serpente, testa_serpente, posizione_mela, velocita_serpente
    direzione = 'DESTRA'
    cambio_direzione = direzione
    mele_mangiate = 0
    lunghezza_serpente = 1
    serpente.clear()
    testa_serpente = [larghezza_schermo / 2, altezza_schermo / 2]
    serpente.append(testa_serpente)
    posizione_mela = [random.randint(1, (larghezza_schermo - dimensione_blocco) // dimensione_blocco) * dimensione_blocco,
                      random.randint(1, (altezza_schermo - dimensione_blocco) // dimensione_blocco) * dimensione_blocco]
    velocita_serpente = 10

def mostra_punteggio(velocita_attuale=''):
    testo = font.render("Mele mangiate: " + str(mele_mangiate), True, bianco)
    schermo.blit(testo, [10, 10])
    testo_velocita = font.render("Velocità: " + str(velocita_attuale), True, bianco)
    schermo.blit(testo_velocita, [larghezza_schermo - 150, 10])

def mostra_testo(testo, colore, y_displacement=0):
    surface = font.render(testo, True, colore)
    rect = surface.get_rect()
    rect.center = (larghezza_schermo / 2), (altezza_schermo / 2) + y_displacement
    schermo.blit(surface, rect)

def salva_gioco():
    stato_gioco = {
        'direzione': direzione,
        'cambio_direzione': cambio_direzione,
        'mele_mangiate': mele_mangiate,
        'lunghezza_serpente': lunghezza_serpente,
        'serpente': serpente,
        'testa_serpente': testa_serpente,
        'posizione_mela': posizione_mela,
        'velocita_serpente': velocita_serpente,
        'dimensione_mela': dimensione_mela,
        'difficolta': difficolta
    }
    with open('salvataggio_gioco.pkl', 'wb') as file:
        pickle.dump(stato_gioco, file)

def carica_gioco():
    global direzione, cambio_direzione, mele_mangiate, lunghezza_serpente, serpente, testa_serpente, posizione_mela, velocita_serpente, dimensione_mela, difficolta
    try:
        with open('salvataggio_gioco.pkl', 'rb') as file:
            stato_gioco = pickle.load(file)
            direzione = stato_gioco['direzione']
            cambio_direzione = stato_gioco['cambio_direzione']
            mele_mangiate = stato_gioco['mele_mangiate']
            lunghezza_serpente = stato_gioco['lunghezza_serpente']
            serpente = stato_gioco['serpente']
            testa_serpente = stato_gioco['testa_serpente']
            posizione_mela = stato_gioco['posizione_mela']
            velocita_serpente = stato_gioco['velocita_serpente']
            dimensione_mela = stato_gioco['dimensione_mela']
            difficolta = stato_gioco['difficolta']
    except FileNotFoundError:
        mostra_testo("Nessun salvataggio trovato.", bianco)
        pygame.display.update()
        pygame.time.wait(2000)

def schermata_salvataggio():
    schermo.fill(nero)
    mostra_testo("Vuoi creare un salvataggio?", bianco, -30)
    mostra_testo("1. Sì", bianco, 10)
    mostra_testo("2. No", bianco, 40)
    pygame.display.update()

    while True:
        for evento in pygame.event.get():
            if evento.type == pygame.QUIT:
                pygame.quit()
                sys.exit()
            if evento.type == pygame.KEYDOWN:
                if evento.key == pygame.K_1:
                    salva_gioco()
                    return
                if evento.key == pygame.K_2:
                    return

def main():
    global direzione, cambio_direzione, mele_mangiate, lunghezza_serpente, serpente, testa_serpente, posizione_mela, fine_partita, dimensione_mela, velocita_serpente

    mostra_menu()

    if difficolta == 'facile':
        velocita_serpente = 10
    elif difficolta == 'normale':
        velocita_serpente = 15
    elif difficolta == 'difficile':
        velocita_serpente = 20

    while True:
        schermo.fill(nero)

        for evento in pygame.event.get():
            if evento.type == pygame.QUIT:
                pygame.quit()
                sys.exit()
            if evento.type == pygame.KEYDOWN:
                if evento.key == pygame.K_LEFT and direzione != 'DESTRA':
                    cambio_direzione = 'SINISTRA'
                if evento.key == pygame.K_RIGHT and direzione != 'SINISTRA':
                    cambio_direzione = 'DESTRA'
                if evento.key == pygame.K_UP and direzione != 'GIU':
                    cambio_direzione = 'SU'
                if evento.key == pygame.K_DOWN and direzione != 'SU':
                    cambio_direzione = 'GIU'
                if evento.key == pygame.K_1:
                    dimensione_mela = 10
                if evento.key == pygame.K_2:
                    dimensione_mela = 15
                if evento.key == pygame.K_3:
                    dimensione_mela = 20
                if evento.key == pygame.K_r:
                    reset_game()
                if evento.key == pygame.K_s:  # Salva il gioco
                    schermata_salvataggio()

        direzione = cambio_direzione

        if direzione == 'SU':
            testa_serpente[1] -= dimensione_blocco
            if difficolta != 'difficile' and testa_serpente[1] < 0:
                testa_serpente[1] = altezza_schermo - dimensione_blocco
        if direzione == 'GIU':
            testa_serpente[1] += dimensione_blocco
            if difficolta != 'difficile' and testa_serpente[1] >= altezza_schermo:
                testa_serpente[1] = 0
        if direzione == 'SINISTRA':
            testa_serpente[0] -= dimensione_blocco
            if difficolta != 'difficile' and testa_serpente[0] < 0:
                testa_serpente[0] = larghezza_schermo - dimensione_blocco
        if direzione == 'DESTRA':
            testa_serpente[0] += dimensione_blocco
            if difficolta != 'difficile' and testa_serpente[0] >= larghezza_schermo:
                testa_serpente[0] = 0

        serpente.append(list(testa_serpente))
        if len(serpente) > lunghezza_serpente:
            del serpente[0]

        if difficolta == 'difficile':
            if testa_serpente[0] < 0 or testa_serpente[0] >= larghezza_schermo or \
                    testa_serpente[1] < 0 or testa_serpente[1] >= altezza_schermo:
                fine_gioco()

        if difficolta != 'facile':
            for blocco in serpente[:-1]:
                if blocco == testa_serpente:
                    fine_gioco()

        if testa_serpente[0] == posizione_mela[0] and testa_serpente[1] == posizione_mela[1]:
            mele_mangiate += 1
            lunghezza_serpente += 1
            posizione_mela = [random.randint(1, (larghezza_schermo - dimensione_blocco) // dimensione_blocco) * dimensione_blocco,
                              random.randint(1, (altezza_schermo - dimensione_blocco) // dimensione_blocco) * dimensione_blocco]
            velocita_serpente += 1

        # Verifica se il serpente ha raggiunto la lunghezza massima possibile
        if lunghezza_serpente == (larghezza_schermo // dimensione_blocco) * (altezza_schermo // dimensione_blocco):
            schermata_vittoria()

        for x in range(0, larghezza_schermo, dimensione_blocco):
            pygame.draw.line(schermo, verde, (x, 0), (x, altezza_schermo))
        for y in range(0, altezza_schermo, dimensione_blocco):
            pygame.draw.line(schermo, verde, (0, y), (larghezza_schermo, y))

        for pos in serpente:
            pygame.draw.rect(schermo, verde, pygame.Rect(pos[0], pos[1], dimensione_blocco, dimensione_blocco))

        schermo.blit(mela_imgs[dimensione_mela], (posizione_mela[0], posizione_mela[1]))

        mostra_punteggio(velocita_serpente)

        pygame.display.update()

        pygame.time.Clock().tick(velocita_serpente)

if __name__ == "__main__":
    main()
